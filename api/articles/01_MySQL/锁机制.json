{"title":"MySQL - 锁","uid":"a268ecb8e7f5610e6bc0d93965482953","slug":"01_MySQL/锁机制","date":"2021-03-20T07:05:07.000Z","updated":"2022-10-05T13:38:02.000Z","comments":true,"path":"api/articles/01_MySQL/锁机制.json","keywords":null,"cover":null,"content":"<p>[TOC]</p>\n<h2 id=\"锁机制\"><a href=\"#锁机制\" class=\"headerlink\" title=\"锁机制\"></a>锁机制</h2><blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><p>计算机协调 多个进程或线程 并发访问某一资源的机制。</p></blockquote>\n<h3 id=\"锁的类型及其特点\"><a href=\"#锁的类型及其特点\" class=\"headerlink\" title=\"锁的类型及其特点\"></a>锁的类型及其特点</h3><p>开销、加锁、颗粒度、冲突、并发等角度分析</p>\n<p>表级锁(table-level locking) 开销大，加锁快，不会出现死锁，颗粒度大，锁冲突概率高，并发度小；</p>\n<p>页面锁(page-level locking) 开销、加锁效率、颗粒度介于表锁和行锁之间，会出现死锁，并发度一般；</p>\n<p>行级锁(row-level locking)  开销大，加速慢，会出现死锁，颗粒度小，锁冲突概率小，并发度高；</p>\n<h3 id=\"锁的类型应用场景\"><a href=\"#锁的类型应用场景\" class=\"headerlink\" title=\"锁的类型应用场景\"></a>锁的类型应用场景</h3><p>表锁 - 适合 以查询为主，只有少量按索引条件更新数据的应用，如web应用；</p>\n<p>行锁 - 适合 大量按索引条件并发 更新少量不同数据，同时又有并发查询的应用，如在线事务处理系统；</p>\n<h3 id=\"锁的支持度及情况\"><a href=\"#锁的支持度及情况\" class=\"headerlink\" title=\"锁的支持度及情况\"></a>锁的支持度及情况</h3><p>MyISAM 只支持 表锁</p>\n<p>InnoDB 默认支持 行锁，也支持表锁</p>\n<pre class=\"line-numbers language-mysql\" data-language=\"mysql\"><code class=\"language-mysql\">-- 查询表锁争用情况\nshow status like &#39;table%&#39;; # Table_locks_waited 大则表锁争用情况严重</code></pre>\n\n<h3 id=\"锁的维度划分\"><a href=\"#锁的维度划分\" class=\"headerlink\" title=\"锁的维度划分\"></a>锁的维度划分</h3><p>共享锁(S) - 读锁</p>\n<p>排他锁(X) - 写锁</p>\n<p>意向共享锁(IS) </p>\n<p>意向排他锁(IX)</p>\n<p>间隙锁</p>\n<h3 id=\"死锁\"><a href=\"#死锁\" class=\"headerlink\" title=\"死锁\"></a>死锁</h3><h4 id=\"死锁的产生原因\"><a href=\"#死锁的产生原因\" class=\"headerlink\" title=\"死锁的产生原因\"></a>死锁的产生原因</h4><ol>\n<li>系统资源不足</li>\n<li>进程运行 推进的顺序&#x2F;速度 不同</li>\n<li>资源分配不当</li>\n</ol>\n<h4 id=\"死锁的必要条件\"><a href=\"#死锁的必要条件\" class=\"headerlink\" title=\"死锁的必要条件\"></a>死锁的必要条件</h4><ol>\n<li>互斥\t\t\t\t\t一个资源每次只能被一个进程使用</li>\n<li>请求与保持    一个进程因请求资源而阻塞时，对已获得的资源保持不放</li>\n<li>不可剥夺        进程已获得的资源，在未使用完之前，不能强行剥夺</li>\n<li>循环等待        若干进程之间形成一种头尾相接的循环等待资源关系</li>\n</ol>\n<h3 id=\"避免死锁\"><a href=\"#避免死锁\" class=\"headerlink\" title=\"避免死锁\"></a>避免死锁</h3><ul>\n<li><p>合理的设计索引，区分度高的列放到组合索引前面，使业务 SQL 尽可能通过索引定位更少的行，减少锁竞争。</p>\n</li>\n<li><p>调整业务逻辑 SQL 执行顺序， 避免 update&#x2F;delete 长时间持有锁的 SQL 在事务前面。</p>\n</li>\n<li><p>避免大事务，将大事务拆成多个小事务</p>\n</li>\n<li><p>以固定的顺序访问表和行。</p>\n<p>比如两个更新数据的事务，</p>\n<p>事务 A 更新数据的顺序为 1，2;</p>\n<p>事务 B 更新数据的顺序为 2，1。</p>\n<p>这样更可能会造成死锁。</p>\n</li>\n<li><p>在并发比较高的系统中，不要显式加锁，特别是是在事务里显式加锁。</p>\n<p>如 select … for update 语句，</p>\n<p>如果是在事务里（运行了 start transaction 或设置了autocommit 等于0）,</p>\n<p>那么就会锁定所查找到的记录。</p>\n</li>\n<li><p>尽量用主键&#x2F;索引去查找记录</p>\n</li>\n<li><p>优化 SQL 和表设计，减少同时占用太多资源的情况。</p>\n<p>比如说，避免多个表join，将复杂 SQL 分解为多个简单的 SQL。</p>\n</li>\n</ul>\n<h4 id=\"死锁的解除与预防\"><a href=\"#死锁的解除与预防\" class=\"headerlink\" title=\"死锁的解除与预防\"></a>死锁的解除与预防</h4><p>打破必要条件之一即可解锁，预防必要条件即可预防死锁。</p>\n<ol>\n<li>按同一顺序访问对象</li>\n<li>避免事务中的用户交互</li>\n<li>保持事务简短并在一个批处理中</li>\n<li>使用低隔离级别</li>\n<li>使用绑定连接</li>\n</ol>\n<h3 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h3><table>\n<thead>\n<tr>\n<th align=\"center\">维度|锁类型</th>\n<th align=\"center\">表级锁</th>\n<th align=\"center\">页面锁</th>\n<th align=\"center\">行级锁</th>\n</tr>\n</thead>\n<tbody><tr>\n<td align=\"center\">内存开销</td>\n<td align=\"center\">大</td>\n<td align=\"center\">中</td>\n<td align=\"center\">大</td>\n</tr>\n<tr>\n<td align=\"center\">加锁效率</td>\n<td align=\"center\">快</td>\n<td align=\"center\">中</td>\n<td align=\"center\">慢</td>\n</tr>\n<tr>\n<td align=\"center\">颗粒度</td>\n<td align=\"center\">大</td>\n<td align=\"center\">中</td>\n<td align=\"center\">小</td>\n</tr>\n<tr>\n<td align=\"center\">锁冲突概率</td>\n<td align=\"center\">高</td>\n<td align=\"center\">中</td>\n<td align=\"center\">低</td>\n</tr>\n<tr>\n<td align=\"center\">是否会死锁</td>\n<td align=\"center\">否</td>\n<td align=\"center\">是</td>\n<td align=\"center\">是</td>\n</tr>\n<tr>\n<td align=\"center\">并发度</td>\n<td align=\"center\">小</td>\n<td align=\"center\">一般</td>\n<td align=\"center\">高</td>\n</tr>\n<tr>\n<td align=\"center\">应用特点</td>\n<td align=\"center\">查询&amp;少量索引条件的更新</td>\n<td align=\"center\">-</td>\n<td align=\"center\">并发查询&amp;大量索引条件的不同数据更新</td>\n</tr>\n<tr>\n<td align=\"center\">应用场景</td>\n<td align=\"center\">Web</td>\n<td align=\"center\">-</td>\n<td align=\"center\">在线事务处理系统</td>\n</tr>\n<tr>\n<td align=\"center\">存储引擎</td>\n<td align=\"center\">MyISAM、InnoDB</td>\n<td align=\"center\">-</td>\n<td align=\"center\">InnoDB</td>\n</tr>\n<tr>\n<td align=\"center\">锁争用参数</td>\n<td align=\"center\"><code>show status like &#39;table%&#39;</code> <br />Table_locks_waited<br /></td>\n<td align=\"center\">-</td>\n<td align=\"center\"><code>show status like &#39;InnoDB_row_lock%&#39;;</code><br />InnoDB_row_lock_waits<br />InnoDB_row_lock_time_avg<br /></td>\n</tr>\n</tbody></table>\n","text":"[TOC] 锁机制 计算机协调 多个进程或线程 并发访问某一资源的机制。 锁的类型及其特点开销、加锁、颗粒度、冲突、并发等角度分析 表级锁(table-level locking) 开销大，加锁快，不会出现死锁，颗粒度大，锁冲突概率高，并发度小； 页面锁(page-level l...","link":"","photos":[],"count_time":{"symbolsCount":"1.6k","symbolsTime":"1 mins."},"categories":[{"name":"MySQL Lock","slug":"MySQL-Lock","count":1,"path":"api/categories/MySQL-Lock.json"}],"tags":[{"name":"MySQL","slug":"MySQL","count":16,"path":"api/tags/MySQL.json"},{"name":"锁","slug":"锁","count":1,"path":"api/tags/锁.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E9%94%81%E6%9C%BA%E5%88%B6\"><span class=\"toc-text\">锁机制</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E9%94%81%E7%9A%84%E7%B1%BB%E5%9E%8B%E5%8F%8A%E5%85%B6%E7%89%B9%E7%82%B9\"><span class=\"toc-text\">锁的类型及其特点</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E9%94%81%E7%9A%84%E7%B1%BB%E5%9E%8B%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF\"><span class=\"toc-text\">锁的类型应用场景</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E9%94%81%E7%9A%84%E6%94%AF%E6%8C%81%E5%BA%A6%E5%8F%8A%E6%83%85%E5%86%B5\"><span class=\"toc-text\">锁的支持度及情况</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E9%94%81%E7%9A%84%E7%BB%B4%E5%BA%A6%E5%88%92%E5%88%86\"><span class=\"toc-text\">锁的维度划分</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E6%AD%BB%E9%94%81\"><span class=\"toc-text\">死锁</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%E6%AD%BB%E9%94%81%E7%9A%84%E4%BA%A7%E7%94%9F%E5%8E%9F%E5%9B%A0\"><span class=\"toc-text\">死锁的产生原因</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%E6%AD%BB%E9%94%81%E7%9A%84%E5%BF%85%E8%A6%81%E6%9D%A1%E4%BB%B6\"><span class=\"toc-text\">死锁的必要条件</span></a></li></ol></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E9%81%BF%E5%85%8D%E6%AD%BB%E9%94%81\"><span class=\"toc-text\">避免死锁</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%E6%AD%BB%E9%94%81%E7%9A%84%E8%A7%A3%E9%99%A4%E4%B8%8E%E9%A2%84%E9%98%B2\"><span class=\"toc-text\">死锁的解除与预防</span></a></li></ol></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E6%80%BB%E7%BB%93\"><span class=\"toc-text\">总结</span></a></li></ol></li></ol>","author":{"name":"Michael","slug":"michael","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"Just Do IT","socials":{"github":"https://github.com/mikeah2011","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/7318914058","zhihu":"https://www.zhihu.com/people/tridiamond","csdn":"https://blog.csdn.net/TriDiamond6","juejin":"https://juejin.cn/user/1873223546578589","customs":{"bilibili":{"icon":"http://localhost:4000/svg/bilibili.svg","link":"https://live.bilibili.com/22619211"},"baidu":{"icon":"iconfont icon-baidu","link":"https://live.bilibili.com/22619211"},"book":{"icon":"far fa-address-book","link":"https://live.bilibili.com/22619211"},"facebook":{"icon":"/svg/facebook.svg","link":"https://facebook.com"}}}},"mapped":true,"prev_post":{"title":"MySQL面试题","uid":"2a240a0b6536e25078add1806f7b654e","slug":"01_MySQL/面试题","date":"2021-03-20T07:05:07.000Z","updated":"2022-10-05T13:38:02.000Z","comments":true,"path":"api/articles/01_MySQL/面试题.json","keywords":null,"cover":[],"text":" ","link":"","photos":[],"count_time":{"symbolsCount":2,"symbolsTime":"1 mins."},"categories":[{"name":"SQL","slug":"SQL","count":15,"path":"api/categories/SQL.json"},{"name":"面试题","slug":"SQL/面试题","count":1,"path":"api/categories/SQL/面试题.json"}],"tags":[{"name":"MySQL","slug":"MySQL","count":16,"path":"api/tags/MySQL.json"}],"author":{"name":"Michael","slug":"michael","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"Just Do IT","socials":{"github":"https://github.com/mikeah2011","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/7318914058","zhihu":"https://www.zhihu.com/people/tridiamond","csdn":"https://blog.csdn.net/TriDiamond6","juejin":"https://juejin.cn/user/1873223546578589","customs":{"bilibili":{"icon":"http://localhost:4000/svg/bilibili.svg","link":"https://live.bilibili.com/22619211"},"baidu":{"icon":"iconfont icon-baidu","link":"https://live.bilibili.com/22619211"},"book":{"icon":"far fa-address-book","link":"https://live.bilibili.com/22619211"},"facebook":{"icon":"/svg/facebook.svg","link":"https://facebook.com"}}}}},"next_post":{"title":"Redis缓存","uid":"3682ab669363b7cc91c7e1f90f676fac","slug":"02_Redis/比较区别_Redis和Memcache","date":"2021-03-20T07:05:07.000Z","updated":"2022-10-05T13:38:02.010Z","comments":true,"path":"api/articles/02_Redis/比较区别_Redis和Memcache.json","keywords":null,"cover":null,"text":"数据结构：memcache仅支持简单的key-value形式，Redis支持的数据更多（string字符串，set集合，list列表，hash散列，zset有序集合）； 多线程：memcache支持多线程，Redis支持单线程 持久化：Redis支持持久化，memcache不支持...","link":"","photos":[],"count_time":{"symbolsCount":"1.4k","symbolsTime":"1 mins."},"categories":[{"name":"Redis","slug":"Redis","count":10,"path":"api/categories/Redis.json"}],"tags":[{"name":"redis","slug":"redis","count":10,"path":"api/tags/redis.json"}],"author":{"name":"Michael","slug":"michael","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"Just Do IT","socials":{"github":"https://github.com/mikeah2011","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"https://weibo.com/u/7318914058","zhihu":"https://www.zhihu.com/people/tridiamond","csdn":"https://blog.csdn.net/TriDiamond6","juejin":"https://juejin.cn/user/1873223546578589","customs":{"bilibili":{"icon":"http://localhost:4000/svg/bilibili.svg","link":"https://live.bilibili.com/22619211"},"baidu":{"icon":"iconfont icon-baidu","link":"https://live.bilibili.com/22619211"},"book":{"icon":"far fa-address-book","link":"https://live.bilibili.com/22619211"},"facebook":{"icon":"/svg/facebook.svg","link":"https://facebook.com"}}}}}}